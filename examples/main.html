<html>
<head>
    <title>Devices</title>
    <script src="config.js"></script>
    <script src="../dist/bundles/index.js"></script>
</head>
<body>
    <div id="results"></div>

    <script>
        var resultsEl = document.getElementById("results");

        function log(message) {
            console.log(message);
            resultsEl.innerText += message + "\n";
        }

        var devices = new window.mbedCloudSDK.Devices(window.config);
        var access = new window.mbedCloudSDK.Access(window.config);

        devices.on(window.mbedCloudSDK.Devices.EVENT_UPDATE, update => {
            log("up:" + update.ep);
        });

        devices.startNotifications();

        devices.getConnected(function(err, devices) {
            devices.forEach(function(device) {
                device.getResources(function(err, resources) {
                    log(device.name);
                    resources.forEach(function(resource) {
                        resource.getSubscription(function(err, value) {
                            if (err) {
                                log(err);
                                return;
                            }
                            log(resource.uri);
                            log("val:" + value);
                        });
                    });
                });
            });
        });

        devices.getConnected()
        .then(iterateDevices);

        function iterateDevices(devices) {
            var promises = devices.map(device => {
                return device.getResources()
                .then(resources => {
                    log(device.name);
                    return iterateResources(resources);
                });
            });

            return Promise.all(promises);
        }

        function iterateResources(resources) {
            var promises = resources.map(resource => {
                return resource.getValue()
                .then(value => {
                    log(resource.uri);
                    log("val:" + value);
                })
                .catch(err => {
                    log(err);
                });
            });

            return Promise.all(promises);
        }

        access.getUsers(function(err, users) {
            users.forEach(user => {
                log(user.full_name);
            });
        });

        access.getUsers()
        .then(users => {
            users.forEach(user => {
                log(user.full_name);
            });
        });

        setTimeout(function() {
            devices.stopNotifications();
        }, 10000);
    </script>
</body>
</html>