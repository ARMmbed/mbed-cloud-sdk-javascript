<html>
<head>
    <title>Devices</title>
    <script src="config.js"></script>
    <script src="../dist/bundles/devices.js"></script>
</head>
<body>
    <div id="results"></div>

    <script>
        var resultsEl = document.getElementById("results");

        function log(message) {
            console.log(message);
            resultsEl.innerText += message + "\n";
        }

        var devices = new window.mbedCloudSDK.Devices(window.config);
 
        devices.on(window.mbedCloudSDK.Devices.EVENT_UPDATE, update => {
            log("up:" + update.ep);
        });

        devices.on(window.mbedCloudSDK.Devices.EVENT_NOTIFICATION, not => {
            log("not:");
        });

        devices.on(window.mbedCloudSDK.Devices.EVENT_REGISTRATION, reg => {
            log("reg:");
        });

        devices.on(window.mbedCloudSDK.Devices.EVENT_DEREGISTRATION, de => {
            log("de:");
        });

        devices.on(window.mbedCloudSDK.Devices.EVENT_EXPIRED, ex => {
            log("ex:");
        });

        devices.startNotifications({
            requestCallback: function(stuff) {
            //    log("cb:");
            }
        });

        devices.getConnected(function(err, devices) {
            devices.forEach(function(device) {
                log(device.name);
                if (device.name === "015968f39ae900000000000100100120") {
                    device.getResources(function(err, resources) {
                        resources.forEach(function(resource) {
                            resource.getValue(function(err, value) {
                                var res = resource.uri + " - ";
                                res += err ? "Error (" + err + ")" : value;
                                log(res);
                                if (resource.obs) {
                                    resource.on(window.mbedCloudSDK.Devices.Resource.EVENT_NOTIFICATION, function(value) {
                                        log(value);
                                    });
                                }
                            });
                        });
                    });
                }
            });
        });
/*
        setTimeout(function() {
            devices.stopNotifications();
        }, 10000);
*/
    </script>
</body>
</html>